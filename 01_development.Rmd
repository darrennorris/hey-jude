---
title: "01_development"
author: "Darren Norris"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    toc: yes
    toc_float: yes
    toc_depth: 3
    fig_caption: yes
  bookdown::pdf_document2:
    toc: yes
    toc_depth: 3
    number_sections: yes
    extra_dependencies: flafter
    highlight: tango
    includes:
      in_header: preamble.txe
always_allow_html: yes
urlcolor: blue
toc-title: Contents
header-includes:
  - \counterwithin{figure}{section}
---

```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(
  echo = TRUE, collapse = TRUE,
  comment = "#>" 
  )
def_hook <- knit_hooks$get("output")
knit_hooks$set(output = function(x, options) {
  out <- def_hook(x, options)
  return(paste("\\begin{framed}\\begin{verbatim}", x, "\\end{verbatim}\\end{framed}", collapse = "\n"))
})
```

\newpage{}

# Load and prep data
## Packages
```{r load-packages, warning=FALSE, message=FALSE}
library(plyr) # plyr b4 tidyverse
library(tidyverse)
library(stringr)
library(readxl)
library(gridExtra)
```

## Journal impact

[Scopus CiteScore](https://www.elsevier.com/solutions/scopus/how-scopus-works/metrics/citescore) and [JCR Journal Impact Factor ("JIF")](https://clarivate.com/webofsciencegroup/solutions/journal-citation-reports/), downloaded on 24 and 23 January 2023 respectively. 
Using 11 years (2011 to 2021), as 2011 is first year for CiteScore and also follows the definition of conservation threats and actions published in 2008 (Salafsky et. al., 2008 A Standard Lexicon for Biodiversity Conservation: Unified Classifications of Threats and Actions https://doi.org/10.1111/j.1523-1739.2008.00937.x). 
The companies classify journals differently and the folder [data](https://github.com/darrennorris/hey-jude/tree/main/data) has JCR impact of  Biodiversity Conservation category journals (JIF https://github.com/darrennorris/hey-jude/tree/main/data/clarivate_JCR) and matching CiteScore (CiteScore: https://github.com/darrennorris/hey-jude/tree/main/data/scopus_citescore). To match, CiteScore comes from a combination of journals in "Nature and Landscape Conservation", "Ecology, Evolution, Behavior and Systematics" and  the following 12:
African Natural History, Proceedings Of The Linnean Society Of New South Wales, Caribbean Journal Of Science, Urban Ecosystems, Natural History, Revista Chilena De Historia Natural, Polar Biology, Pachyderm, Global Change Biology, Bulletin Of The American Museum Of Natural History, American Museum Novitates, Journal Of Applied Ecology. 


Code below loads and joins CiteScore to JIF. 
```{r load-journal-impact}
jcr_11a21 <-read_excel("data/clarivate_JCR/JCR2011a2021.xlsx", 
           na = c("", "NA", "N/A")) %>% 
  mutate(Journal_name = if_else(Journal_name =="Eco mont-Journal on Protected Mountain Areas Research", "Eco.mont", 
          Journal_name)) %>%
  mutate(name_join = str_to_upper(str_replace_all(Journal_name, "[:punct:]", "")))
cs_NLC_11a21 <-read_excel("data/scopus_citescore/citescore_NLC_2011a2021.xlsx", 
           na = c("", "NA", "N/A")) %>% 
  mutate(SourceTitle = if_else(SourceTitle=="Natureza a Conservacao", "Natureza & Conservacao", SourceTitle)) %>%
  mutate(name_join = str_to_upper(str_replace_all(SourceTitle, "[:punct:]", "")))
# conservation and ecology
cs_NLCECO_11a21 <-read_excel("data/scopus_citescore/citescore_NLC_ECO_2011a2021.xlsx", 
           na = c("", "NA", "N/A")) %>%
  #drop structural NAs
  filter(!is.na(CiteScore)) %>% 
    mutate(SourceTitle = if_else(SourceTitle %in% c("Natureza a Conservacao"), 
                                 "Natureza & Conservacao", SourceTitle)) %>%
  mutate(name_join = str_to_upper(str_replace_all(SourceTitle, "[:punct:]", "")))

jcr_11a21 %>% left_join(cs_NLCECO_11a21, 
                        by = c("ayear"="ayear", 
                               "name_join" = "name_join")) -> journals_11a21
# 12 journals. Differences due to differences in journals and coverage years 
# between databases used to calculate JCR JIF and Scopus CiteScore.
journals_11a21 %>% 
  group_by(name_join) %>% summarise(count_na = sum(is.na(CiteScore))) %>% 
    filter(count_na >0) %>%
  arrange(desc(count_na)) %>% data.frame


```

Calculate descriptive summaries.
```{r journal-impact-summaries, message=FALSE, warning=FALSE}
journals_11a21 %>%  
  mutate(ayear = as.character(ayear)) %>% 
  select(ayear, name_join, JIF, CiteScore) %>%
  pivot_longer(cols = c(JIF, CiteScore), names_to = "indicator") %>% 
  filter(!is.na(value)) %>%
  group_by(ayear, indicator) %>% 
  summarise(journal_count = length(unique(name_join)),
            journal_impact = median(value),
            lq = quantile(value, probs=0.025), 
            uq = quantile(value, probs=0.975)) %>% 
    ungroup() -> journals_11a21_sum
# start and end values over time
count_years <- length(unique(journals_11a21_sum$ayear))
start_year <- min(journals_11a21_sum$ayear)
end_year <- max(journals_11a21_sum$ayear)
journals_11a21_sum %>% filter(ayear==start_year, indicator=="JIF") %>% 
  pull(journal_impact) -> start_JIF
journals_11a21_sum %>% filter(ayear==start_year, indicator=="JIF") %>% 
  pull(journal_count) -> start_count
journals_11a21_sum %>% filter(ayear==end_year, indicator=="JIF") %>% 
  pull(journal_impact) -> end_JIF
journals_11a21_sum %>% filter(ayear==end_year, indicator=="JIF") %>% 
  pull(journal_count) -> end_count

```

The number of JCR Biodiversity Conservation journals increased from `r start_count` to `r end_count` over  `r count_years` years.

Plot to check.
```{r plot-journals-year, out.width="70%", out.height="70%", fig.cap= "Trends in indicators of impacts across conservaiton journals."}
journals_11a21 %>%  
  mutate(ayear = as.character(ayear)) %>% 
  select(ayear, name_join, JIF, CiteScore) %>%
  pivot_longer(cols = c(JIF, CiteScore), names_to = "indicator") %>% 
    filter(!is.na(value)) %>%
  ggplot(aes(x=ayear, y=value)) + 
  geom_point() + 
  geom_boxplot() +
  facet_wrap(~indicator, nrow = 2, scales = "free_y")
```


Plot to check. Median impact and number of journals per year.
```{r plot-journals-year-count, message=FALSE, warning=FALSE,out.width="70%", out.height="70%", fig.cap= "Trends in journal number and indicators of impact across conservaiton journals. Points are median values with verticle lines showing 95% interval of value ranges (0.025 - 0.975 quantile range)."}
journals_11a21_sum %>%
  # use group = 1 so lines go through year which is a factor
  ggplot(aes(x=ayear, y=journal_impact, group=1)) + 
  geom_line(colour="blue", linewidth=1) +
  geom_errorbar(aes(ymin=lq, ymax=uq), width=.1) +
  geom_point(aes(size=journal_count)) + 
  scale_size_continuous("journal\ncount") +
  facet_wrap(~indicator, nrow = 2, scales = "free_y") + 
  labs(x="year", 
       y="impact indicator value")
```

## Literature search results

Load bibliometric packages.
```{r load-packages-bibliometrics, message=FALSE, warning=FALSE}
library(bibliometrix)
library(rcrossref)
library(rAltmetric)
library(metagear)

```


Load bibliographic data
```{r load-search}
# WOS core collection. AB =  Abstract, DI = doi, SO = journal title, TC = times cited, 
# TI = article title, PY = publication year, 

# 1) helper functions
# file names
get_files <- function(folder_name = NA) {
  library(tidyverse)
  folder_location <- folder_name
  in_files <- list.files(folder_location, 
                         pattern = ".bib", full.names = TRUE)
  data.frame(folder_id = folder_location, file_id = in_files) %>%  
    group_by(folder_id, file_id) %>% 
    summarise(file_count = n()) %>% 
    ungroup() -> df_files
  return(df_files)
}
# load files
load_bib <- function(x){ 
  myrefs <- bibliometrix::convert2df(file = x$file_id, dbsource = "wos", 
                                           format = "bibtex") 
  myrefs
}
# update mergeDbSources to work with list object
mergeDbSourcesDN <- function(x,remove.duplicated=TRUE){

###
  L <- x
  
  n=length(L)
  
  Tags=names(L[[1]])

  ## identification of common tags
  for (j in 2:n){
    Tags=intersect(Tags,names(L[[j]]))
  }
  #####
  M=data.frame(matrix(NA,1,length(Tags)))
  names(M)=Tags
  for (j in 1:n){
    L[[j]]=L[[j]][,Tags]
    
    M=rbind(M,L[[j]])
  }
  
  ## author data cleaning
  if ("AU" %in% Tags){
    M$AU=gsub(","," ",M$AU)
    AUlist=strsplit(M$AU,";")
    AU=lapply(AUlist,function(l){
      l=trim(l)
      name=strsplit(l," ")
      lastname=unlist(lapply(name,function(ln){ln[1]}))
      firstname=lapply(name,function(ln){
        f=paste(substr(ln[-1],1,1),collapse=" ")
        })
      AU=paste(lastname,unlist(firstname),sep=" ",collapse=";")
      return(AU)
    })
    M$AU=unlist(AU)
    
  }
  M=M[-1,]
  M$DB="ISI"
  
  if (isTRUE(remove.duplicated)){
    M$TI=gsub("[^[:alnum:] ]","",M$TI)
    M$TI=gsub("(?<=[\\s])\\s*|^\\s+|\\s+$", "", M$TI, perl=TRUE)
    d=duplicated(M$TI)
    cat("\n",sum(d),"duplicated documents have been removed\n")
    M=M[!d,]
  }
  class(M) <- c("bibliometrixDB", "data.frame")
  return(M)
}

# 2) import 
infolder <- "data/wos_20230130/"
df_files_wos <- get_files(folder_name = infolder)
lwos <- plyr::alply(df_files_wos, .margins = 1, .fun = load_bib)
# 16795 ( 1 duplicate removed)
wosDN <- mergeDbSourcesDN(lwos, remove.duplicated=TRUE)

```

